<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Chemistry helper</title>
        <style>
            body {
                height: 100%;
                background-color: #D8D8D8;
                display: flex;
            }

            .input {
                margin: 30px;
                padding: 15px;
                min-height: 25px;
                background-color: #AAAAAA;
            }
            span.invalid {
                color: red;
            }

            #nameConverter, #equationBalancer {
                width: 50%;
                padding: 5%;
            }

        </style>
    </head>
    <body>
        <div id="nameConverter">
            <div class="input" id="words" oninput="parseWords('#nameConverter #words')" contenteditable spellcheck="false">
                H<sub>2</sub>O
            </div>
            <div class="input" id="symbols" oninput="convertFormulaMolecule()" contenteditable spellcheck="false" tabindex="0"></div>
        </div>
        <div id="equationBalancer">
            <div class="input" id="words" contenteditable spellcheck="false">
                hydrochloric acid
            </div>
        </div>
        <!-- superscript and subscript are <sup> and <sub>, wikipedia uses font-size: 80% -->

        <script type="text/javascript">

			document.querySelector(".input#symbols").innerHTML = "C3H2O2(Cl6SO4)3";  //temporary

            Array.prototype.divide = function(compareFunction){
                let result = [], next = [], remaining = Array.from(this);
                while(remaining.length){
                    let element = remaining.shift();
                    next.push(element);
                    if(!remaining.length || compareFunction(element, remaining[0])){
                        result.push(next);
                        next = [];
                    }
                }
                return result;
            };
            String.prototype.divide = function(compareFunction){ return this.split("").divide(compareFunction).map(s => s.join("")) };
            const titleCase = str => str.split("").map((x,i) => i ? x.toLowerCase() : x.toUpperCase()).join("");
            const charType = char => Number(char) >= 0 ? "number" : char && char.toUpperCase() != char.toLowerCase() ? "letter" : "other";

            let elements = [];
            let polyIons = [];
            const romanNumerals = ["I","II","III","IV","V","VI","VII","VIII","IX","X"];
            const prefixes = ["mono","di","tri","tetra","penta","hexa","hepta","octa","nona","deca"];  //cut off the last letter if length>3 and the base word starts with "o"
            const stableShells = [0,2,10,18,36,54,86,118];




            fetch("https://raw.githubusercontent.com/FrogFlint/frogflint.github.io/master/ElementInfo.txt")
            .then(response => response.text())
            .then(commit => {
                let info = commit.split("\n\n").map(x => x.split("\n").map(x => x.split(" ")));
                info[1].forEach(
                    ([name,symbol,charges],index) =>
                    elements[index] = new Element(
                        titleCase(name),
                        titleCase(symbol),
                        charges.split(",").map(x => parseInt(x)),
                        Number(index) + 1
                    )
                );
                polyIons = info[3].map(str => ({name: str[0], formula: str[1]}));
            });



            function Element(name, symbol, charges, atomicNumber){
                this.name = name;
                this.symbol = symbol;
                this.charges = charges;  //prefered ionic charges
                this.atomicNumber = atomicNumber;

                this.period = stableShells.findIndex(shellSize => shellSize >= atomicNumber);
                this.group = atomicNumber - stableShells[this.period - 1];
                if(this.group > 2 || !this.charges[0]) this.group = 18 - (stableShells[this.period] - atomicNumber);  //not quite the standard definition
                this.isMetal = this.period > 1 && this.group < this.period + 12;
            }




            function convertWordMolecule(){
                document.querySelector("#nameConverter #symbols").innerHTML = parseFormula(document.querySelector("#nameConverter #words"));
            }
            function convertFormulaMolecule(){
                document.querySelector("#nameConverter #words").innerHTML = parseFormula(document.querySelector("#nameConverter #symbols"));
            }

			function parseBrackets(text){
				let bracketDifference = [];
				text.split("").reduce((acc, char, i) => bracketDifference[i] = acc + ((char == "(") - (char == ")")), 0);
				let pre = -Math.min(0, ...bracketDifference), post = Math.max(bracketDifference.reverse()[0], 0);
				text = "(".repeat(pre) + text + ")".repeat(post);

				let tree = parseSubscripts(layer(text));


				return [pre, post, tree];
			}
			function layer(text){
				let i = text.indexOf("(");
				if(i < 0) return findPolyIons(text);
				bracketDifference = 1;
				for(let j = i + 1; j < text.length; j++){
					bracketDifference += ((text[j] == "(") - (text[j] == ")"));
					if(!bracketDifference) return [...findPolyIons(text.slice(0, i)), {contents: parseSubscripts(layer(text.slice(i + 1, j)))}, ...layer(text.slice(j + 1))];//.filter(x => x.length || x.count);
				}
			}
			function parseFormulaLine(line){  //big changes/rewrite with most of the same bits
				//polyIons.forEach(ion => )                         //ex:  {name: "sulphate", formula: "SO4"}
				let compound = line
					.flatMap(x => Array.isArray(x) ? [{contents: parseFormulaLine(x), count: 1}] : findPolyIons(x)
						.flatMap(y => Array.isArray(y) ? [] : []))/*
					.divide((a,b) => charType(a) != charType(b))
                    .flatMap(str => Number(str) || str.divide((a,b) => b != b.toLowerCase()))
					.divide((a,b) => !(typeof a == "string" && typeof b == "number"))
					.map(x => Array.isArray(x) ? {name: (elements.find(e => e.symbol == x[0]) || {name:"invalid"}).name, symbol: x[0], count: x[1] || 1} : x);

				//*/
				return compound;

				//ex:  {name: "Lithium", symbol: "Li", count: 1}     or    {name: "invalid", symbol: "Mm, count: 4}
			}
			const parseSubscripts = line =>  //and identify elements
				line.divide((a,b) => typeof b != "number").map(([thing, num]) => typeof thing == "number" ? thing : Object.assign(typeof thing == "string" ?
				{name: (elements.find(e => e.symbol == thing) || {name:"invalid"}).name, symbol: thing} : thing, {count: num || "1"}));

			function findPolyIons(text){  //rename now that it calls atomSplit
				for(let ion of polyIons){
					for(let i = text.length - ion.formula.length; i >= 0; i--){
						if(text.slice(i, i + ion.formula.length) == ion.formula && charType(text[i + ion.formula.length]) != "number")
							return [...findPolyIons(text.slice(0, i)), {name: ion.name, formula: ion.formula}, ...atomSplit(text.slice(i + ion.formula.length))];//.filter(x => x.length || x.formula || typeof x == "number");
					}
				}
				return atomSplit(text);
			}

			const atomSplit = str => str.divide((a,b) => charType(a) != charType(b) || b != b.toLowerCase()).map(x => Number(x) || x);  //split text into numbers and strings with uppercase start


			let s = {
				red: str => "<span class=\"invalid\">" + str + "</span>",
				sub: str => "<sub>" + str + "</sub>"
			};
			const formulaToStyleText = formula => formula.map(x => typeof x == "number" ? s.red(s.sub(x)) :
				(x.contents ? "(" + formulaToStyleText(x.contents) + ")" : x.name == "invalid" ? s.red(x.symbol) : x.symbol || formulaToStyleText(parseSubscripts(atomSplit(x.formula)))) +
				(x.count === "1" ? "" : s.sub(x.count))
			).join("");

            function parseWords(input){}
            function parseFormula(input){

                let [preBrackets, postBrackets, molecule] = parseBrackets(input.innerText);


				let nodes = Array.from(input.childNodes);

                let sel = window.getSelection();
				let pos = sel.focusOffset + nodes.slice(0, nodes.findIndex(node => sel.containsNode(node, true))).reduce((acc, node) => acc + (node.innerText || node.wholeText).length, 0);

				let text = formulaToStyleText(molecule);
                input.innerHTML = text.slice(preBrackets, text.length - postBrackets);

				input.childNodes.forEach(node => {
					let len = (node.innerText || node.wholeText).length;
					if(pos < len && pos >= 0){
						let range = document.createRange();
						range.setStart(node, pos);
						range.collapse(true);
						sel.removeAllRanges();
						sel.addRange(range);
					}
					pos -= len;
				});


            }



            /* Anion suffixes
                ine -> ide
                on ->
                _gen ->
                ium ->
                orus ->
                ic ->
            */


        </script>
    </body>
</html>
